<!DOCTYPE html>
<html>
<head>
    <title>Token Received</title>
</head>
<body>
    <script>
        // Получаем токен
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get('access_token');

        if (token) {
            console.log("Token found:", token);
            
            // Сразу отправляем токен в Pastebin через GitHub Pages
            // Используем CORS прокси чтобы обойти ограничения
            const pastebinData = new URLSearchParams();
            pastebinData.append('api_dev_key', 'PASTEBIN_API_KEY_PLACEHOLDER'); // Заменится
            pastebinData.append('api_option', 'paste');
            pastebinData.append('api_paste_code', `Token: ${token}\nTime: ${new Date().toISOString()}`);
            pastebinData.append('api_paste_name', `Twitch Token ${Date.now()}`);
            pastebinData.append('api_paste_private', '1');
            pastebinData.append('api_paste_format', 'text');
            
            // Отправляем запрос к нашему GitHub Action через специальный endpoint
            fetch('https://api.github.com/repos/eendychan/twitch-bot-auth/dispatches', {
                method: 'POST',
                headers: {
                    'Authorization': 'token GITHUB_TOKEN_PLACEHOLDER', // Заменится
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    event_type: 'new_token',
                    client_payload: {
                        token: token
                    }
                })
            })
            .then(response => {
                if (response.ok) {
                    document.body.innerHTML = `
                        <h2 style="color: green;">✅ Authorization Successful!</h2>
                        <p>Token has been automatically saved. You can close this window.</p>
                    `;
                } else {
                    throw new Error('GitHub API error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.body.innerHTML = `
                    <h2 style="color: green;">✅ Authorization Successful!</h2>
                    <p>Token: ${token}</p>
                    <p>But there was an error saving automatically.</p>
                `;
            });
            
        } else {
            document.body.innerHTML = '<h2 style="color: red;">❌ No Token Received</h2>';
        }
    </script>
</body>
</html>
